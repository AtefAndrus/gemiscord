# Gemini Discord Bot ä»•æ§˜æ›¸ v6.0

## æ¦‚è¦

Discord ã§ Gemini API (Function Calling) + Brave Search API ã‚’çµ±åˆã—ãŸ AI ãƒœãƒƒãƒˆ

## å®Ÿè£…çŠ¶æ³

### âœ… Phase 0-1 å®Œäº† (2025 å¹´ 6 æœˆ)

- **TypeScript å‹å®šç¾©**: å…¨å‹ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Œå‚™
- **è¨­å®šã‚·ã‚¹ãƒ†ãƒ **: YAML + keyv/SQLite ãƒ‡ãƒ¥ã‚¢ãƒ«æ§‹æˆ
- **Discord åŸºç›¤**: bot.ts, handlers, message å‡¦ç†
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- **ãƒ­ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼**: æ§‹é€ åŒ–ãƒ­ã‚°, ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
- **ãƒ†ã‚¹ãƒˆ**: å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆå®Œå‚™ (80%+ ã‚«ãƒãƒ¬ãƒƒã‚¸)

### ğŸ”œ Phase 2 æ¬¡æœŸå®Ÿè£…

- Gemini API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ + Function Calling
- Brave Search API çµ±åˆ
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»ãƒ¢ãƒ‡ãƒ«åˆ‡æ›¿ã‚·ã‚¹ãƒ†ãƒ 
- AI å¿œç­”çµ±åˆ (messageCreate.ts:154 ç½®æ›)

### â³ Phase 3-4 è¨ˆç”»

- ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…
- ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç† (ç”»åƒå¯¾å¿œ)
- æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ç›£è¦–

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| åˆ†é‡    | æŠ€è¡“                | ãƒãƒ¼ã‚¸ãƒ§ãƒ³     | çŠ¶æ…‹ |
| ------- | ------------------- | -------------- | ---- |
| Runtime | Bun + TypeScript    | 1.2.15, strict | âœ…   |
| Discord | discord.js          | v14.19.3       | âœ…   |
| AI      | @google/genai       | latest         | ğŸ”œ   |
| Search  | Brave Search API    | v1             | ğŸ”œ   |
| Storage | keyv + @keyv/sqlite | latest         | âœ…   |
| Test    | Jest                | latest         | âœ…   |
| Deploy  | Docker (Coolify)    | -              | â³   |

## è¨­å®šã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜

### å®Ÿè£…æ¸ˆã¿è¨­å®šã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```typescript
// YAMLé™çš„è¨­å®š (config/bot-config.yaml)
interface YAMLConfig {
  prompts: { system: string; ... };
  function_calling: { search_web: {...}, count_characters: {...} };
  response_handling: { strategies: {...} };
  models: { [model: string]: ModelConfig };
  cache: { ttl_minutes: {...} };
}

// å‹•çš„è¨­å®š (keyv/SQLite)
interface GuildConfig {
  mention_enabled: boolean;      // @botå¿œç­”æœ‰åŠ¹/ç„¡åŠ¹
  response_channels: string[];   // è‡ªå‹•å¿œç­”ãƒãƒ£ãƒ³ãƒãƒ«ID
  search_enabled: boolean;       // æ¤œç´¢æ©Ÿèƒ½æœ‰åŠ¹/ç„¡åŠ¹
  server_prompt?: string;        // ã‚µãƒ¼ãƒãƒ¼å°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  message_limit_strategy: 'compress' | 'split';
}

interface ChannelConfig {
  channel_prompt?: string;       // ãƒãƒ£ãƒ³ãƒãƒ«å°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
}
```

### è¨­å®šãƒ†ã‚¹ãƒˆçŠ¶æ³

- âœ… ConfigManager: YAML èª­ã¿è¾¼ã¿ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… ConfigService: keyv å‹•çš„è¨­å®š CRUD
- âœ… çµ±åˆãƒ†ã‚¹ãƒˆ: è¨­å®šéšå±¤ç®¡ç†
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ä¸æ­£è¨­å®šæ¤œè¨¼

## ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ä»•æ§˜

### å®Ÿè£…æ¸ˆã¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

```typescript
// ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ (sanitizer.ts)
<@123456789> â†’ [ãƒ¦ãƒ¼ã‚¶ãƒ¼]
<@&456789123> â†’ [ãƒ­ãƒ¼ãƒ«]
<#789123456> â†’ [ãƒãƒ£ãƒ³ãƒãƒ«]
@here/@everyone â†’ [ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³]
```

### å‡¦ç†ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

```typescript
// Phase 2ã§å®Ÿè£…äºˆå®š
1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ â†’ ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ âœ…
2. è¨­å®šç¢ºèª (mention/channelåˆ¤å®š) âœ…
3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ (éšå±¤ãƒãƒ¼ã‚¸)
4. Gemini APIå‘¼ã³å‡ºã— + Function Calling
5. æ¤œç´¢å®Ÿè¡Œ (å¿…è¦æ™‚)
6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç† (åœ§ç¸®/åˆ†å‰²)
7. Discordé€ä¿¡
```

## AI çµ±åˆä»•æ§˜ (Phase 2 å®Ÿè£…äºˆå®š)

### Function Calling è¨­è¨ˆ

```yaml
# YAMLå®šç¾©æ¸ˆã¿ (å®Ÿè£…æº–å‚™å®Œäº†)
search_web:
  name: "search_web"
  description: "Webã§æœ€æ–°æƒ…å ±ã‚’æ¤œç´¢"
  parameters:
    query: string (required)
    region: string (default: "JP")

count_characters:
  name: "count_characters"
  description: "æ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ"
  parameters:
    text: string (required)
```

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»•æ§˜

| ãƒ¢ãƒ‡ãƒ«                        | RPM | TPM  | RPD  | å®Ÿè£…çŠ¶æ…‹          |
| ----------------------------- | --- | ---- | ---- | ----------------- |
| gemini-2.5-flash-preview-0520 | 10  | 250K | 500  | ğŸ”œ å„ªå…ˆ           |
| gemini-2.0-flash              | 15  | 1M   | 1500 | ğŸ”œ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |

- **åˆ¶å¾¡**: keyv TTL ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
- **åˆ‡æ›¿**: 80%åˆ°é”ã§è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **ç›£è¦–**: ä½¿ç”¨é‡çµ±è¨ˆãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

### æ¤œç´¢åˆ¶é™ä»•æ§˜

- **Brave Search**: æœˆ 2,000 ã‚¯ã‚¨ãƒªç„¡æ–™
- **è¶…éå‡¦ç†**: æ¤œç´¢ç„¡åŠ¹åŒ–, ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ã®ã¿
- **ç®¡ç†**: æœˆåˆ¥ä½¿ç”¨é‡è¿½è·¡ (keyv)

## ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†ä»•æ§˜

### æ–‡å­—åˆ¶é™å¯¾å¿œ (Phase 2 å®Ÿè£…äºˆå®š)

```typescript
// Discord 2000æ–‡å­—åˆ¶é™
strategy: "compress" | "split";

// åœ§ç¸®ãƒ¢ãƒ¼ãƒ‰: è¦ç´„ã—ã¦1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
// åˆ†å‰²ãƒ¢ãƒ¼ãƒ‰: è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ†å‰²é€ä¿¡
```

### å¿œç­”ãƒˆãƒªã‚¬ãƒ¼

1. **ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¿œç­”**: `@bot ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`
2. **ãƒãƒ£ãƒ³ãƒãƒ«å¿œç­”**: è¨­å®šæ¸ˆã¿ãƒãƒ£ãƒ³ãƒãƒ«å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
3. **è¨­å®šåˆ¶å¾¡**: guild åˆ¥/channel åˆ¥æœ‰åŠ¹/ç„¡åŠ¹

## ãƒ†ã‚¹ãƒˆä»•æ§˜

### å®Ÿè£…æ¸ˆã¿ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

```bash
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ config.test.ts         âœ… 80%+
â”‚   â”‚   â””â”€â”€ configManager.test.ts  âœ… 80%+
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ logger.test.ts         âœ… 80%+
â”‚       â””â”€â”€ sanitizer.test.ts      âœ… 80%+
â”œâ”€â”€ integration/
â”‚   â””â”€â”€ config-integration.test.ts âœ… ä¸»è¦ãƒ•ãƒ­ãƒ¼
â””â”€â”€ fixtures/                     âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
```

### ãƒ†ã‚¹ãƒˆå“è³ªåŸºæº–

- **å˜ä½“ãƒ†ã‚¹ãƒˆ**: 80%+ ã‚«ãƒãƒ¬ãƒƒã‚¸
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: ä¸»è¦ãƒ•ãƒ­ãƒ¼ 100%
- **ãƒ¢ãƒƒã‚¯**: å¤–éƒ¨ä¾å­˜å®Œå…¨åˆ†é›¢
- **CI**: è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

## Phase 2 å®Ÿè£…æº–å‚™çŠ¶æ³

### æº–å‚™å®Œäº†é …ç›®

âœ… å‹å®šç¾© (gemini.types.ts, search.types.ts)
âœ… è¨­å®šã‚·ã‚¹ãƒ†ãƒ  (Function å®£è¨€å®šç¾©æ¸ˆã¿)
âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹)
âœ… ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ (Jest è¨­å®šå®Œäº†)
âœ… ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  (æ§‹é€ åŒ–ãƒ­ã‚°)

### å®Ÿè£…å¿…è¦é …ç›®

ğŸ”œ src/services/gemini.ts
ğŸ”œ src/services/braveSearch.ts
ğŸ”œ src/services/rateLimit.ts
ğŸ”œ messageCreate.ts AI çµ±åˆ (L154)

### é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

- ğŸ“‹ IMPLEMENTATION_PLAN.md: è©³ç´°æ‰‹é †
- ğŸ“ CLAUDE.md: å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- ğŸ§ª TDD: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆé–‹ç™º
- ğŸ“– API Docs: å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¿…é ˆç¢ºèª
