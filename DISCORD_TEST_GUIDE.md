# Discord 実環境テスト指示書 - Phase 3 完了版

## 概要

**Gemiscord Phase 3 実装完了** - AI 統合・検索機能・レート制限・スラッシュコマンドの実環境テスト

## 事前準備

### 1. ボット起動

```bash
# .env ファイル設定確認
cat .env
# 必要な環境変数:
# - DISCORD_TOKEN=your_discord_bot_token
# - GEMINI_API_KEY=your_gemini_api_key
# - BRAVE_SEARCH_API_KEY=your_brave_search_api_key

# ボット起動
bun run src/bot.ts
```

**期待結果**:

- ✅ `Ready! Logged in as BotName#1234`
- ✅ `GeminiService initialized`
- ✅ `BraveSearchService initialized`
- ✅ `RateLimitService initialized`

### 2. Discord サーバー準備

**必要な設定**:

- テスト用サーバー作成 (管理者権限)
- ボット招待 (必要権限: メッセージ送信、履歴読取、リアクション追加)
- テストチャンネル作成: `#bot-test`, `#auto-response-test`

---

## Phase 3 機能テスト (スラッシュコマンド含む)

### 🤖 **T1. 基本 AI 応答テスト**

#### T1-1. メンション応答

**テスト手順**:

```
#bot-test チャンネルで送信:
@YourBot こんにちは！調子はどうですか？
```

**期待結果**:

- ✅ ボットがタイピング表示 (2-3 秒)
- ✅ 日本語で AI 応答が返る
- ✅ 5 秒以内に応答
- ✅ エラーが発生しない

#### T1-2. 自然な会話

**テスト手順**:

```
@YourBot 今日の予定について相談したいです
@YourBot TypeScriptとJavaScriptの違いを教えて
@YourBot 面白いジョークを聞かせて
```

**期待結果**:

- ✅ 文脈に応じた適切な応答
- ✅ 日本語の自然な表現
- ✅ エラーハンドリング正常

### 🔍 **T2. 検索機能統合テスト**

#### T2-1. リアルタイム情報検索

**テスト手順**:

```
@YourBot 今日の東京の天気はどうですか？
@YourBot 最新のAI技術のニュースを教えて
@YourBot 2024年のオリンピックについて調べて
```

**期待結果**:

- ✅ 自動的に web 検索が実行される
- ✅ 検索結果に基づいた回答
- ✅ 「🔍 検索中...」などの検索実行表示
- ✅ 最新情報が含まれている

#### T2-2. 検索不要な質問

**テスト手順**:

```
@YourBot 1+1はいくつですか？
@YourBot プログラミングの基本概念について説明して
@YourBot こんにちは
```

**期待結果**:

- ✅ 検索せずに直接回答
- ✅ 高速応答 (2 秒以内)
- ✅ 適切な判断

### ⚡ **T3. Function Calling テスト**

#### T3-1. 文字数カウント機能

**テスト手順**:

```
@YourBot この文章の文字数を数えて：「こんにちは、世界！今日は良い天気ですね。」
@YourBot 「Hello World」の文字数は？
```

**期待結果**:

- ✅ `count_characters` 関数が自動実行
- ✅ 正確な文字数が返答に含まれる
- ✅ 実行ログが出力される

#### T3-2. 検索関数の自動判断

**テスト手順**:

```
@YourBot 現在の円相場はいくらですか？
@YourBot 最新のTech系イベント情報
@YourBot 今話題のNetflixドラマは？
```

**期待結果**:

- ✅ `search_web` 関数が自動実行
- ✅ 適切な検索キーワード生成
- ✅ 関数実行 → 最終回答の流れ

### 📊 **T4. レート制限・モデル切替テスト**

#### T4-1. 連続リクエスト

**テスト手順**:

```
10回連続で送信:
@YourBot テスト1
@YourBot テスト2
...
@YourBot テスト10
```

**期待結果**:

- ✅ 全リクエストが正常処理
- ✅ レスポンス時間が徐々に長くなる可能性
- ✅ エラーが発生しない
- ✅ モデル切替ログが出力される可能性

#### T4-2. 高負荷テスト

**テスト手順**:

```
短時間 (1分) で15-20回送信:
@YourBot 重い検索: [複雑な質問]
@YourBot 長い質問: [500文字程度の質問]
```

**期待結果**:

- ✅ `gemini-2.5-flash` → `gemini-2.0-flash` 自動切替
- ✅ レート制限到達時の適切なメッセージ
- ✅ サービス停止しない

### 📝 **T5. メッセージ長制限対応テスト**

#### T5-1. 長い回答の処理

**テスト手順**:

```
@YourBot 日本の歴史について詳しく教えて
@YourBot プログラミング言語の種類をすべて説明して
@YourBot 長い小説を書いて
```

**期待結果**:

- ✅ 2000 文字を超える場合、自動分割
- ✅ 複数メッセージに分かれて送信
- ✅ `(1/3)`, `(2/3)`, `(3/3)` の形式
- ✅ 内容が途切れない

#### T5-2. 日本語処理

**テスト手順**:

```
@YourBot 日本語の複雑な文章: 「これは長い日本語の文章です...」(長文)
@YourBot 絵文字と特殊文字: 🤖💻🔥✨
```

**期待結果**:

- ✅ 日本語の適切な文字数カウント
- ✅ 絵文字が正しく処理される
- ✅ 分割位置が自然

### 🔄 **T6. チャンネル自動応答テスト**

### ⚙️ **T7. スラッシュコマンドテスト (Phase 3 新機能)**

#### T7-1. /status コマンド

**テスト手順**:

```
管理者アカウントで実行:
/status
```

**期待結果**:

- ✅ ボット状態・稼働時間が表示される
- ✅ API 使用量統計が表示される
- ✅ メモリ使用量が表示される
- ✅ 3 秒以内に応答

#### T7-2. /config コマンド

**テスト手順**:

```
/config view
/config mention disable
/config mention enable
/config channel add #test-channel
/config channel remove #test-channel
/config prompt set "カスタムプロンプト"
/config strategy split
```

**期待結果**:

- ✅ 各サブコマンドが正常動作
- ✅ 設定変更が即座に反映
- ✅ 適切な確認メッセージ

#### T7-3. /search コマンド

**テスト手順**:

```
/search quota
/search toggle disable
/search toggle enable
/search test "今日のニュース"
```

**期待結果**:

- ✅ クォータ使用量表示
- ✅ 検索機能の有効/無効切替
- ✅ テスト検索の正常実行

#### T7-4. /model コマンド

**テスト手順**:

```
/model info
/model stats
/model limits
```

**期待結果**:

- ✅ 現在の AI モデル情報表示
- ✅ 使用統計情報表示
- ✅ レート制限状況表示

#### T7-5. 権限テスト

**テスト手順**:

```
非管理者アカウントで実行:
/status
/config view
```

**期待結果**:

- ✅ 「管理者権限が必要」メッセージ
- ✅ コマンドが実行されない

#### T6-1. 自動応答チャンネル設定

**設定方法**:

```bash
# 設定ファイル編集 (config/bot-config.yaml)
# または、動的設定 (実装されている場合)
```

**テスト手順**:

```
#auto-response-test チャンネルで:
天気はどうですか？ (メンションなし)
最新ニュースは？ (メンションなし)
```

**期待結果**:

- ✅ メンションなしでも AI 応答
- ✅ 他チャンネルでは応答しない
- ✅ 設定変更が即座に反映

### 🚨 **T8. エラーハンドリングテスト**

#### T8-1. API 制限到達

**テスト手順**:

```
# 意図的に制限到達まで連続送信
@YourBot テスト (30回以上連続)
```

**期待結果**:

- ✅ 「利用量上限」の適切なメッセージ
- ✅ ボットがクラッシュしない
- ✅ 制限解除後に正常復旧

#### T8-2. 不正入力テスト

**テスト手順**:

```
@YourBot [極端に長いメッセージ 5000文字]
@YourBot 🤖🤖🤖🤖🤖 (絵文字のみ)
@YourBot <@everyone> @here (危険なメンション)
```

**期待結果**:

- ✅ サニタイゼーション正常動作
- ✅ 適切なエラーメッセージ
- ✅ セキュリティ問題なし

### 📈 **T9. パフォーマンステスト**

#### T9-1. 応答時間測定

**テスト項目**:

- 🕐 簡単な質問: 2 秒以内
- 🔍 検索必要: 5 秒以内
- 💭 複雑な質問: 8 秒以内

#### T9-2. 同時リクエスト

**テスト手順**:

```
複数ユーザーで同時に送信:
User1: @YourBot 質問1
User2: @YourBot 質問2
User3: @YourBot 質問3
```

**期待結果**:

- ✅ 全ユーザーに適切に応答
- ✅ 応答順序が適切
- ✅ メモリ使用量正常

---

## 🎯 **合格基準**

### 必須テスト (Phase 3 完了認定)

- ✅ T1: 基本 AI 応答 (100%成功)
- ✅ T2: 検索機能統合 (90%以上成功)
- ✅ T3: Function Calling (100%成功)
- ✅ T4: レート制限処理 (正常動作)
- ✅ T5: メッセージ長制限 (正常分割)
- ✅ T7: スラッシュコマンド (100%成功)

### 推奨テスト (品質確認)

- ✅ T6: チャンネル自動応答
- ✅ T8: エラーハンドリング
- ✅ T9: パフォーマンス

### 品質指標

- **応答率**: 95%以上
- **平均応答時間**: 5 秒以内
- **エラー率**: 5%以下
- **連続稼働**: 1 時間以上

---

## 📋 **テスト記録テンプレート**

### テスト実行記録

```
実行日時: 2025年6月6日
テスト環境: Discord Server [サーバー名]
ボットバージョン: Phase 3 完了版

□ T1-1: メンション応答 - ✅成功 / ❌失敗
□ T1-2: 自然な会話 - ✅成功 / ❌失敗
□ T2-1: 検索機能 - ✅成功 / ❌失敗
□ T2-2: 検索判断 - ✅成功 / ❌失敗
□ T3-1: 文字数カウント - ✅成功 / ❌失敗
□ T3-2: 検索関数 - ✅成功 / ❌失敗
□ T4-1: 連続リクエスト - ✅成功 / ❌失敗
□ T4-2: 高負荷テスト - ✅成功 / ❌失敗
□ T5-1: 長い回答 - ✅成功 / ❌失敗
□ T5-2: 日本語処理 - ✅成功 / ❌失敗
□ T6-1: 自動応答 - ✅成功 / ❌失敗
□ T7-1: /statusコマンド - ✅成功 / ❌失敗
□ T7-2: /configコマンド - ✅成功 / ❌失敗
□ T7-3: /searchコマンド - ✅成功 / ❌失敗
□ T7-4: /modelコマンド - ✅成功 / ❌失敗
□ T7-5: 権限テスト - ✅成功 / ❌失敗
□ T8-1: API制限 - ✅成功 / ❌失敗
□ T8-2: 不正入力 - ✅成功 / ❌失敗
□ T9-1: 応答時間 - ✅成功 / ❌失敗
□ T9-2: 同時リクエスト - ✅成功 / ❌失敗

総合評価: ✅Phase 3 完了認定 / ❌要修正
```

### 不具合報告

```
エラー内容:
再現手順:
期待結果:
実際の結果:
ログ出力:
```

---

## 🚀 **次のステップ**

### Phase 3 完了後

✅ **Phase 4 実装準備** (次期機能):

- ファイル処理 (画像アップロード対応)
- 高度な設定管理 UI
- ユーザー別設定管理

✅ **Phase 4 本番デプロイ準備**:

- Docker 化
- Coolify 設定
- 監視・ログ集約
- 本番環境テスト

---

## 📞 **サポート**

### 問題が発生した場合

1. **ログ確認**: `bun run src/bot.ts` の出力
2. **設定確認**: `.env`, `config/bot-config.yaml`
3. **API 状態確認**: Gemini API, Brave Search API
4. **Issue 報告**: [GitHub Issues](https://github.com/your-repo/gemiscord/issues)

### 実装者向け

- **詳細実装**: `IMPLEMENTATION_PLAN.md`
- **開発ガイド**: `CLAUDE.md`
- **型定義**: `src/types/`
- **テストスイート**: `tests/`

---

**🎉 Phase 3 完了おめでとうございます！**
**Gemiscord の全機能(スラッシュコマンド含む)が稼働中です。**
